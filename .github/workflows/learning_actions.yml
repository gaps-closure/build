name: learn-github-actions
run-name: ${{ github.actor }} is learning github actions
on: [push]

jobs:
  devcontainer-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        
    container: 
      image: gapsclosure/closuredev:develop
#      options: --env "HOME=/home/closure"
      options: --user closure     
    steps:
      - name: who am I
        run:  whoami
      - name: check PATH
        run: printenv PATH
#      - name: look for conflict_analyzer
#        run: which conflict_analyzer
      - name: closureenv
        run:  source /opt/closure/etc/closureenv; printenv PATH; printenv PYTHONPATH
#       - name: reload .bashrc 
#        run:  source /home/closure/.bash_profile
      - name: what is home
        run: echo $HOME
#      - name: test conflict analyzer in the container
#       run: source /home/closure/.bash_profile; conflict_analyzer --help
      - name: test multiline string
        run: |
          source /home/closure/.bash_profile
          printenv PATH
          printenv PYTHONPATH
          cd /home/closure
          git clone --recurse-submodules https://github.com/gaps-closure/build.git
          find . -name example1 -print
          echo "### Testing example1"
          cd build/apps/examples/example1
          vstask "0 CLEAN SOURCE"
          vstask "1 ANNOTATE"
          cp .solution/refactored/*.c annotated/
          ls -ltra annotated/*.c
          vstask "2 ANALYZE PARTITION CONFLICTS"
          checkFiles=(topology.json artifact.json)
          for i in "${checkFiles[@]}"; do [ -f ./$i ] && echo "$i exists" || { echo "$i is not found"; false; } done
          vstask "9a DIVIDE"
          myEnclaves=$(grep "export ENCLAVES=" .make/closure_env.sh | sed -ne 's/export ENCLAVES="//p' |sed -ne 's/"//p')
          echo $myEnclaves
          IFS=' ' read -ra ArrEc <<< $myEnclaves
          for i in "${ArrEc[@]}"; do [ -d divvied/$i ] && echo "Directory for $i exists" || { echo "divvied/$i does not exist"; false; } done
          vstask "9b AUTOGEN GEDL, RPCs, IDL, Codecs"
          efiles=($(find ./partitioned/multithreaded -type f -not \( -name "*.a" -o -name "*.o" -o -name "*.so" -o -name "*example1" \) ))
          for i in ${efiles[@]}; 
          do j=$(sed 's/./.\/.solution/' <<< $i); md5_i=($(md5sum $i)); md5_j=($(md5sum $j)); 
          echo "${md5_i[0]} ${md5_j[0]} ${md5_i[1]}";
          if ((${md5_i[0]} != $md5_j[0]})); then {echo "md5sum for ${md5_i[1]} does not match"; false; }; fi; done
          md5_ll=$(find . -type f -exec md5sum {} \;)
          echo $md5_ll
          cd ../../.solution/partitioned/multithreaded
          md5_so=$(find . -type f -exec md5sum {} \;)
          echo $md5_so
          cd ../../../
          vstask "9c VERIFY"
          vstask "9d BUILD"
          find partitioned/multithreaded -type f -executable
          source .make/closure_env.sh; make -f .make/mbig.make hal
          find partitioned/multithreaded -type f -exec md5sum {} \; |grep "hal.*cfg"
          
          
  check-pytest-version:
    runs-on: ubuntu-latest
    steps:      
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          submodules: true

      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ðŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - run: echo "ðŸ This job's status is ${{ job.status }}."

      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v7
        
      - name: Current branch name
        run: |
          echo "${{ steps.branch-name.outputs.current_branch }}"
#      - name: install pytest
#        run: pip install -U pytest
#      - name: test docker pull
#        run: docker pull gapsclosure/closuredev:develop
